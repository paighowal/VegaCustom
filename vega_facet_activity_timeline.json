{
  // Vega Lite v5 schema for Deneb visualization
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  
  // Data source configuration - expects a dataset named "dataset"
  "data": {
    "name": "dataset"
  },
  // Data transformations to calculate reference dates and prepare data
  "transform": [
    {
      // Calculate the start of the current quarter for timeline reference
      "calculate": "datetime(year(now()), quarter(now()) * 3 - 2, 1)",
      "as": "StartOfCurrentQuarter"
    },
    {
      // Calculate the start of the current year (January 1st)
      "calculate": "datetime(year(now()), 0, 1)",
      "as": "StartOfCurrentYear"
    },
    {
      // Calculate the end of the current year (January 1st of next year)
      "calculate": "datetime(year(now()) + 1, 0, 1)",
      "as": "EndOfCurrentYear"
    },
    {
      // Create a concatenated milestone field for tooltips
      "calculate": "datum.StartMilestoneDate",
      "as": "ConcatenatedMilestone"
    }
  ],
  // First level of faceting: Group by Funding Source/Sponsor Type
  "facet": {
    "row": {
      "field": "Funding Source / Sponsor Type",
      "type": "nominal",
      "title": "Funding Source",
      "spacing": 0,
      "header": {
        "labelAngle": 0,
        "title": "Funding Source",
        "labelAlign": "center",
        "labelPadding": 0
      }
    }
  },
  // Second level of faceting: Group by Study Name within each funding source
  "spec": {
    "facet": {
      "row": {
        "field": "Study_Name",
        "type": "nominal",
        "title": "Study_Name",
        "spacing": 0,
        "header": {
          "labelAngle": 0,
          "title": "Study_Name",
          "labelAlign": "left",
          // Split study names on '|' character for better display
          "labelExpr": "split(datum.label, '|')"
        }
      }
    },
    // Third level of faceting: Group by Milestone Name within each study
    "spec": {
      "facet": {
        "row": {
          "field": "Milestone Name",
          "type": "nominal",
          "title": "Milestone Name",
          "spacing": 0,
          "header": {
            "labelAngle": 0,
            "title": null,
            "labelAlign": "left",
            "labels": false  // Hide milestone labels to reduce clutter
          },
          // Sort milestones chronologically by start date
          "sort": {
            "field": "StartMilestoneDate",
            "order": "ascending"
          }
        }
      },
      // Individual timeline visualization for each milestone
      "spec": {
        "height": 35,  // Fixed height for each milestone row
        "layer": [
          // Background layer: Current year highlight rectangle
          {"params": [
              {"name": "grid", "select": "interval", "bind": "scales"}
            ],
            "mark": {
              "type": "rect",
              "color": "lightgrey",
              "opacity": 0.3,
              "borderColor": "lightgrey"
            },
            "encoding": {
              "x": {
                "field": "StartOfCurrentYear",
                "type": "temporal"
              },
              "x2": {
                "field": "EndOfCurrentYear",
                "type": "temporal"
              }
            }
          },
          // Vertical line: Start of current year marker
          {
            "mark": {
              "type": "rule",
              "color": "gray",
              "size": 2,
              "strokeDash": [4, 4]  // Dashed line style
            },
            "encoding": {
              "x": {
                "field": "StartOfCurrentYear",
                "type": "temporal"
              }
            }
          },
          // Vertical line: End of current year marker
          {
            "mark": {
              "type": "rule",
              "color": "gray",
              "size": 2,
              "strokeDash": [4, 4]  // Dashed line style
            },
            "encoding": {
              "x": {
                "field": "EndOfCurrentYear",
                "type": "temporal"
              }
            }
          },
          // Main milestone points layer
          {
            "mark": {
              "type": "point",
              "size": 200,
              "opacity": 0.9,
              "filled": true
            },
            "encoding": {
              // X-axis: Milestone start date, grouped by year-quarter
              "x": {
                "field": "StartMilestoneDate",
                "type": "temporal",
                "timeUnit": "yearquarter",
                "scale": {
                  "padding": 20
                },
                "axis": {
                  "title": "",
                  "labelAngle": 0,
                  "labelOverlap": false,
                  "grid": false,
                  "format": "%Y-Q%q",
                  "labelExpr": "timeFormat(datum.value, '%Y') + ' Q' + quarter(datum.value)",
                  "orient": "top"
                }
              },
              // Color encoding: Different colors for milestone status
              "color": {
                "field": "Milestone Type",
                "type": "nominal",
                "title": "Milestone Type",
                "scale": {
                  "domain": ["Future Milestone", "Accomplished Milestone"],
                  "range": ["orange", "green"]  // Orange for future, green for accomplished
                },
                "legend": {
                  "orient": "right",
                  "direction": "vertical",
                  "labelLimit": 200,
                  "symbolSize": 200
                }
              },
              // Shape encoding: Different shapes for different milestone names
              "shape": {
                "field": "Milestone Name",
                "type": "nominal",
                "legend": {
                  "orient": "right",
                  "direction": "vertical",
                  "labelLimit": 200,
                  "symbolSize": 200
                }
              },
              // Tooltip configuration: Information shown on hover
              "tooltip": [
                {
                  "field": "ConcatenatedMilestone",
                  "type": "nominal",
                  "title": "Milestone Name"
                },
                {
                  "field": "StartMilestoneDate",
                  "type": "temporal",
                  "title": "Start Date"
                },
                {
                  "field": "Study_Name",
                  "type": "nominal",
                  "title": "Study ID"
                },
                {
                  "field": "Funding Source / Sponsor Type",
                  "type": "nominal",
                  "title": "Funding Source"
                }
              ]
            }
          },
          // Text labels layer: Milestone names positioned next to points
          {
            "mark": {
              "type": "text",
              "align": "right",
              "dx": -10,  // Offset text to the left of the point
              "dy": 0
            },
            "encoding": {
              "x": {
                "field": "StartMilestoneDate",
                "type": "temporal",
                "timeUnit": "yearquarter"
              },
              "text": {
                "field": "Milestone Name",
                "type": "nominal"
              }
            }
          }
        ]
      }
    }
    ,
  // Scale resolution: Independent Y scales for each facet
  "resolve": {"scale": {"y": "independent"}}
  },
  // Scale resolution: Independent Y scales for each facet
  "resolve": {"scale": {"y": "independent"}},
  // Global configuration settings for the visualization
  "config": {
    "view": {
      "width": 1000,
      "stroke": "gainsboro",
      "strokeWidth": -12,
      "padding": 0
    },
    "facet": {
      "spacing": 10  // Adjusted spacing between facet panels
    },
    "header": {
      "labelAlign": "left",
      "labelFontSize": 15,
      "titleFontSize": 20
    },
    "axisX": {
      "labelAlign": "center",
      "domainColor": "black",
      "labelPadding": 0
    },
    "axisY": {
      "domainColor": "black",
      "grid": false  // Remove Y-axis grid lines for cleaner appearance
    }
  }
}
